<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mi Perfil | LEVEL-UP GAMER</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Orbitron:wght@700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./assets/css/registro.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>
  <header role="banner">
    <div class="logo" role="img" aria-label="Level-Up Gamer Logo">🎮 Level-Up Gamer</div>
    <nav role="navigation" aria-label="Navegación principal">
      <ul>
        <li><a href="./index.html">Inicio</a></li>
        <li><a href="./productos.html">Productos</a></li>
        <li><a href="./comunidad.html">Comunidad</a></li>
        <li><a href="./carrito.html" aria-label="Carrito de compras"><i class="fa-solid fa-cart-plus" aria-hidden="true"></i><span id="carritoCount" aria-label="Número de productos en el carrito">0</span></a></li>
        <li><a href="#" onclick="logout()" aria-label="Cerrar sesión"><i class="fa-solid fa-sign-out-alt" aria-hidden="true"></i></a></li>
      </ul>
    </nav>
  </header>
  
  <main class="main">
    <div class="profile-container">
      <!-- Información del perfil -->
      <div class="card profile-card">
        <div class="profile-header">
          <div class="profile-avatar">
            <img id="profileAvatar" src="https://via.placeholder.com/150/1E90FF/FFFFFF?text=U" alt="Avatar del usuario">
            <button class="avatar-upload" onclick="document.getElementById('avatarInput').click()">
              <i class="fa-solid fa-camera" aria-hidden="true"></i>
            </button>
            <input type="file" id="avatarInput" accept="image/*" style="display: none;" onchange="uploadAvatar(event)">
          </div>
          <div class="profile-info">
            <h1 id="profileName">Cargando...</h1>
            <p id="profileEmail">Cargando...</p>
            <p id="profileRole" class="role-badge">Usuario</p>
          </div>
        </div>
        
        <div class="profile-stats">
          <div class="stat">
            <i class="fa-solid fa-shopping-bag" aria-hidden="true"></i>
            <span id="totalOrders">0</span>
            <small>Pedidos</small>
          </div>
          <div class="stat">
            <i class="fa-solid fa-calendar" aria-hidden="true"></i>
            <span id="memberSince">-</span>
            <small>Miembro desde</small>
          </div>
          <div class="stat">
            <i class="fa-solid fa-star" aria-hidden="true"></i>
            <span id="userLevel">1</span>
            <small>Nivel</small>
          </div>
        </div>
      </div>

      <!-- Pestañas de navegación -->
      <div class="profile-tabs">
        <button class="tab-button active" onclick="showTab('personal')">
          <i class="fa-solid fa-user" aria-hidden="true"></i>
          Información Personal
        </button>
        <button class="tab-button" onclick="showTab('orders')">
          <i class="fa-solid fa-shopping-bag" aria-hidden="true"></i>
          Mis Pedidos
        </button>
        <button class="tab-button" onclick="showTab('security')">
          <i class="fa-solid fa-lock" aria-hidden="true"></i>
          Seguridad
        </button>
        <button class="tab-button" onclick="showTab('preferences')">
          <i class="fa-solid fa-cog" aria-hidden="true"></i>
          Preferencias
        </button>
      </div>

      <!-- Contenido de las pestañas -->
      <div class="tab-content">
        <!-- Información Personal -->
        <div id="personal-tab" class="tab-panel active">
          <div class="card">
            <h2>Información Personal</h2>
            <form id="personalForm" class="form-grid">
              <div class="col-2">
                <label for="editFirstName">Nombre</label>
                <input class="input" type="text" id="editFirstName" name="firstName">
              </div>
              
              <div class="col-2">
                <label for="editLastName">Apellido</label>
                <input class="input" type="text" id="editLastName" name="lastName">
              </div>
              
              <div class="col-2">
                <label for="editPhone">Teléfono</label>
                <input class="input" type="tel" id="editPhone" name="phone">
              </div>
              
              <div class="col-2">
                <label for="editDateOfBirth">Fecha de Nacimiento</label>
                <input class="input" type="date" id="editDateOfBirth" name="dateOfBirth">
              </div>
              
              <div class="col-2">
                <label for="editAddress">Dirección</label>
                <textarea class="input" id="editAddress" name="address" rows="3"></textarea>
              </div>
              
              <div class="col-2 actions">
                <button type="button" class="btn btn--ghost" onclick="resetPersonalForm()">Cancelar</button>
                <button type="submit" class="btn btn--primary">Guardar Cambios</button>
              </div>
            </form>
          </div>
        </div>

        <!-- Mis Pedidos -->
        <div id="orders-tab" class="tab-panel">
          <div class="card">
            <h2>Mis Pedidos</h2>
            <div id="ordersList" class="orders-list">
              <!-- Los pedidos se cargarán aquí -->
            </div>
          </div>
        </div>

        <!-- Seguridad -->
        <div id="security-tab" class="tab-panel">
          <div class="card">
            <h2>Cambiar Contraseña</h2>
            <form id="passwordForm" class="form-grid">
              <div class="col-2">
                <label for="currentPassword">Contraseña Actual</label>
                <div class="password-input">
                  <input class="input" type="password" id="currentPassword" name="currentPassword" required>
                  <button type="button" class="password-toggle" onclick="togglePassword('currentPassword')">
                    <i class="fa-solid fa-eye" aria-hidden="true"></i>
                  </button>
                </div>
              </div>
              
              <div class="col-2">
                <label for="newPassword">Nueva Contraseña</label>
                <div class="password-input">
                  <input class="input" type="password" id="newPassword" name="newPassword" required>
                  <button type="button" class="password-toggle" onclick="togglePassword('newPassword')">
                    <i class="fa-solid fa-eye" aria-hidden="true"></i>
                  </button>
                </div>
              </div>
              
              <div class="col-2">
                <label for="confirmNewPassword">Confirmar Nueva Contraseña</label>
                <div class="password-input">
                  <input class="input" type="password" id="confirmNewPassword" name="confirmNewPassword" required>
                  <button type="button" class="password-toggle" onclick="togglePassword('confirmNewPassword')">
                    <i class="fa-solid fa-eye" aria-hidden="true"></i>
                  </button>
                </div>
              </div>
              
              <div class="col-2 actions">
                <button type="button" class="btn btn--ghost" onclick="resetPasswordForm()">Cancelar</button>
                <button type="submit" class="btn btn--primary">Cambiar Contraseña</button>
              </div>
            </form>
          </div>
        </div>

        <!-- Preferencias -->
        <div id="preferences-tab" class="tab-panel">
          <div class="card">
            <h2>Preferencias</h2>
            <form id="preferencesForm" class="form-grid">
              <div class="col-2">
                <div class="checkbox-group">
                  <input type="checkbox" id="prefNewsletter" name="newsletter">
                  <label for="prefNewsletter">Recibir newsletter con ofertas especiales</label>
                </div>
              </div>
              
              <div class="col-2">
                <div class="checkbox-group">
                  <input type="checkbox" id="prefNotifications" name="notifications">
                  <label for="prefNotifications">Recibir notificaciones de pedidos</label>
                </div>
              </div>
              
              <div class="col-2">
                <label for="prefTheme">Tema</label>
                <select class="input" id="prefTheme" name="theme">
                  <option value="dark">Oscuro</option>
                  <option value="light">Claro</option>
                  <option value="auto">Automático</option>
                </select>
              </div>
              
              <div class="col-2 actions">
                <button type="button" class="btn btn--ghost" onclick="resetPreferencesForm()">Cancelar</button>
                <button type="submit" class="btn btn--primary">Guardar Preferencias</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer role="contentinfo">
    <p>&copy; 2025 Level-Up Gamer. Todos los derechos reservados.</p>
  </footer>

  <script src="./js/userManager.js"></script>
  <script src="./js/orderManager.js"></script>
  <script src="./js/productos.js"></script>
  <script>
    let currentUser = null;

    // Inicializar página de perfil
    document.addEventListener('DOMContentLoaded', function() {
      checkAuthentication();
      loadUserProfile();
      bindFormEvents();
    });

    function checkAuthentication() {
      currentUser = window.userManager.getCurrentUser();
      if (!currentUser) {
        window.location.href = './login.html';
        return;
      }
    }

    function loadUserProfile() {
      if (!currentUser) return;

      // Cargar información básica
      document.getElementById('profileName').textContent = 
        `${currentUser.firstName} ${currentUser.lastName}`;
      document.getElementById('profileEmail').textContent = currentUser.email;
      
      const roleBadge = document.getElementById('profileRole');
      roleBadge.textContent = currentUser.role === 'admin' ? 'Administrador' : 'Usuario';
      roleBadge.className = `role-badge ${currentUser.role}`;

      // Cargar estadísticas
      const memberSince = new Date(currentUser.createdAt).toLocaleDateString('es-CL');
      document.getElementById('memberSince').textContent = memberSince;

      // Cargar pedidos del usuario
      const userOrders = window.orderManager.getUserOrders(currentUser.id);
      document.getElementById('totalOrders').textContent = userOrders.length;

      // Calcular nivel del usuario (basado en pedidos)
      const userLevel = Math.floor(userOrders.length / 5) + 1;
      document.getElementById('userLevel').textContent = userLevel;

      // Cargar formularios con datos actuales
      loadPersonalForm();
      loadPreferencesForm();
      loadOrdersList();
    }

    function loadPersonalForm() {
      const form = document.getElementById('personalForm');
      form.firstName.value = currentUser.firstName || '';
      form.lastName.value = currentUser.lastName || '';
      form.phone.value = currentUser.phone || '';
      form.dateOfBirth.value = currentUser.dateOfBirth || '';
      form.address.value = currentUser.address || '';
    }

    function loadPreferencesForm() {
      const form = document.getElementById('preferencesForm');
      form.newsletter.checked = currentUser.preferences?.newsletter || false;
      form.notifications.checked = currentUser.preferences?.notifications || false;
      form.theme.value = currentUser.preferences?.theme || 'dark';
    }

    function loadOrdersList() {
      const ordersList = document.getElementById('ordersList');
      const userOrders = window.orderManager.getUserOrders(currentUser.id);

      if (userOrders.length === 0) {
        ordersList.innerHTML = '<p class="no-orders">No tienes pedidos aún</p>';
        return;
      }

      ordersList.innerHTML = userOrders.map(order => `
        <div class="order-item">
          <div class="order-header">
            <h3>Pedido #${order.id}</h3>
            <span class="order-status status-${order.status}">${getStatusText(order.status)}</span>
          </div>
          <div class="order-details">
            <p><strong>Fecha:</strong> ${new Date(order.createdAt).toLocaleDateString('es-CL')}</p>
            <p><strong>Total:</strong> $${order.totals.total.toLocaleString()} CLP</p>
            <p><strong>Productos:</strong> ${order.items.length} item(s)</p>
          </div>
          <div class="order-items">
            ${order.items.map(item => `
              <div class="order-item-product">
                <img src="${item.image}" alt="${item.name}" class="order-product-image">
                <div class="order-product-info">
                  <h4>${item.name}</h4>
                  <p>Cantidad: ${item.quantity}</p>
                  <p>Precio: $${item.price.toLocaleString()} CLP</p>
                </div>
              </div>
            `).join('')}
          </div>
          <div class="order-actions">
            ${order.status === 'pending' ? 
              `<button class="btn btn--ghost" onclick="cancelOrder('${order.id}')">Cancelar Pedido</button>` : 
              ''
            }
            <button class="btn btn--primary" onclick="viewOrderDetails('${order.id}')">Ver Detalles</button>
          </div>
        </div>
      `).join('');
    }

    function getStatusText(status) {
      const statusTexts = {
        'pending': 'Pendiente',
        'confirmed': 'Confirmado',
        'processing': 'Procesando',
        'shipped': 'Enviado',
        'delivered': 'Entregado',
        'cancelled': 'Cancelado'
      };
      return statusTexts[status] || status;
    }

    function bindFormEvents() {
      // Formulario de información personal
      document.getElementById('personalForm').addEventListener('submit', handlePersonalUpdate);
      
      // Formulario de contraseña
      document.getElementById('passwordForm').addEventListener('submit', handlePasswordChange);
      
      // Formulario de preferencias
      document.getElementById('preferencesForm').addEventListener('submit', handlePreferencesUpdate);
    }

    function handlePersonalUpdate(event) {
      event.preventDefault();
      
      const formData = new FormData(event.target);
      const updateData = Object.fromEntries(formData.entries());
      
      const result = window.userManager.updateProfile(currentUser.id, updateData);
      
      if (result.success) {
        currentUser = result.user;
        loadUserProfile();
        showNotification('Información personal actualizada exitosamente', 'success');
      } else {
        showNotification(result.message, 'error');
      }
    }

    function handlePasswordChange(event) {
      event.preventDefault();
      
      const formData = new FormData(event.target);
      const currentPassword = formData.get('currentPassword');
      const newPassword = formData.get('newPassword');
      const confirmPassword = formData.get('confirmNewPassword');
      
      if (newPassword !== confirmPassword) {
        showNotification('Las contraseñas no coinciden', 'error');
        return;
      }
      
      if (newPassword.length < 4) {
        showNotification('La nueva contraseña debe tener al menos 4 caracteres', 'error');
        return;
      }
      
      const result = window.userManager.changePassword(currentUser.id, currentPassword, newPassword);
      
      if (result.success) {
        resetPasswordForm();
        showNotification('Contraseña cambiada exitosamente', 'success');
      } else {
        showNotification(result.message, 'error');
      }
    }

    function handlePreferencesUpdate(event) {
      event.preventDefault();
      
      const formData = new FormData(event.target);
      const preferences = {
        newsletter: formData.get('newsletter') === 'on',
        notifications: formData.get('notifications') === 'on',
        theme: formData.get('theme')
      };
      
      const result = window.userManager.updateProfile(currentUser.id, { preferences });
      
      if (result.success) {
        currentUser = result.user;
        showNotification('Preferencias actualizadas exitosamente', 'success');
      } else {
        showNotification(result.message, 'error');
      }
    }

    function showTab(tabName) {
      // Ocultar todas las pestañas
      document.querySelectorAll('.tab-panel').forEach(panel => {
        panel.classList.remove('active');
      });
      
      document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active');
      });
      
      // Mostrar pestaña seleccionada
      document.getElementById(tabName + '-tab').classList.add('active');
      event.target.classList.add('active');
    }

    function resetPersonalForm() {
      loadPersonalForm();
    }

    function resetPasswordForm() {
      document.getElementById('passwordForm').reset();
    }

    function resetPreferencesForm() {
      loadPreferencesForm();
    }

    function togglePassword(fieldId) {
      const field = document.getElementById(fieldId);
      const button = field.nextElementSibling;
      const icon = button.querySelector('i');
      
      if (field.type === 'password') {
        field.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
      } else {
        field.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
      }
    }

    function uploadAvatar(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('profileAvatar').src = e.target.result;
          // Aquí podrías guardar la imagen en el perfil del usuario
        };
        reader.readAsDataURL(file);
      }
    }

    function cancelOrder(orderId) {
      if (confirm('¿Estás seguro de que quieres cancelar este pedido?')) {
        const result = window.orderManager.cancelOrder(orderId, 'Cancelado por el usuario');
        if (result.success) {
          loadOrdersList();
          showNotification('Pedido cancelado exitosamente', 'success');
        } else {
          showNotification(result.message, 'error');
        }
      }
    }

    function viewOrderDetails(orderId) {
      const order = window.orderManager.getOrderById(orderId);
      if (order) {
        alert(`Detalles del pedido #${order.id}\n\nEstado: ${getStatusText(order.status)}\nTotal: $${order.totals.total.toLocaleString()} CLP\nFecha: ${new Date(order.createdAt).toLocaleDateString('es-CL')}`);
      }
    }

    function logout() {
      if (confirm('¿Estás seguro de que quieres cerrar sesión?')) {
        window.userManager.logout();
        window.location.href = './index.html';
      }
    }

    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `notification notification-${type}`;
      notification.textContent = message;
      
      const colors = {
        success: '#39FF14',
        error: '#FF4444',
        info: '#1E90FF'
      };

      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${colors[type] || colors.info};
        color: ${type === 'success' ? '#000' : '#fff'};
        padding: 15px 20px;
        border-radius: 8px;
        z-index: 1000;
        animation: slideIn 0.3s ease;
        max-width: 400px;
        word-wrap: break-word;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      `;

      document.body.appendChild(notification);

      setTimeout(() => {
        notification.remove();
      }, 5000);
    }
  </script>
</body>
</html>
